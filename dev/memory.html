<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>hsk-libs-dev: Variables and Memory</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">hsk-libs-dev
   &#160;<span id="projectnumber">257</span>
   </div>
   <div id="projectbrief">High Speed Karlsruhe XC878 library collection</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('memory.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Variables and Memory </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Infineon/XC878.h header defines some unsigned data types:</p><ul>
<li>bool (1 bit)</li>
<li>ulong (32 bits)</li>
<li>uword (16 bits)</li>
<li>ubyte (8 bits)</li>
</ul>
<p>Signed types should only be used when necessary, floating point arithmetic should be avoided if in any way possible.</p>
<p>The correct place to store a variable depends on four factors:</p><ul>
<li>Size</li>
<li>Lifetime</li>
<li>Frequency of use during lifetime</li>
<li>Overlay possibility</li>
</ul>
<p>Size, and frequency are the most obvious, considering <a class="el" href="platform.html#platform_memory">Memory Limitations</a>. It is desireable to use fast memory for frequently accessed variables. Large data structures like buffers, arrays and structs simply use too much of the precious memory space to put them anywhere but <code>xdata</code>.</p>
<p>Both the C51 and SDCC compilers use a technique called overlay to fit all variables into memory. A stack is only used in reentrant functions. Only <code>data/idata</code> variables can be stacked with <code>push/pop</code> instructions. Stacking <code>xdata</code> is emulated in software and thus very slow.</p>
<p>The overlay approach is to build a call graph and thus decide which variables are never used at the same time. These variables are mapped to the same fixed memory addresses.</p>
<p>Variables with a long lifetime are locals in the <a class="el" href="main_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667" title="Call init functions and invoke the run routine. ">main()</a> function, static variables and global variables. These variables have to keep their state during the entire runtime. Thus they use memory space that cannot be shared with other variables.</p>
<p>ISRs and functions called by ISRs also cannot share memory, because there is no sensible way to make sure that a given function is not running when an interrupt occurs. In technical terms, each ISR is the root node of its own call graph.</p>
<p>The following table lists recommended memory types:</p>
<table class="doxtable">
<tr>
<th>Context </th><th>Size </th><th>Critical </th><th>Memory  </th></tr>
<tr>
<td>* </td><td>bool </td><td>* </td><td>bit </td></tr>
<tr>
<td>parameter </td><td>* </td><td>* </td><td>data </td></tr>
<tr>
<td>const </td><td>* </td><td>* </td><td>code </td></tr>
<tr>
<td>local </td><td>byte, word </td><td>* </td><td>data, idata </td></tr>
<tr>
<td></td><td>&gt;= long </td><td>no </td><td>xdata </td></tr>
<tr>
<td></td><td></td><td>ISR/blocking </td><td>pdata, xdata </td></tr>
<tr>
<td>static/global </td><td>* </td><td>no </td><td>xdata </td></tr>
<tr>
<td></td><td></td><td>ISR/blocking </td><td>pdata, xdata </td></tr>
</table>
<p><code>ISR/blocking</code> refers to memory accessed by ISRs, functions called back by ISRs and sections of code that block an interrupt.</p>
<h1><a class="anchor" id="memory_overlay"></a>
Implications of Overlaying</h1>
<p>First and foremost, <a class="el" href="platform.html#platform_memory_overlaying">Overlaying</a> is only performed for the default memory. This project is built around the small memory model, i.e. only <code>data</code> memory is overlaid by SDCC and C51.</p>
<p>The <code>data</code> memory is only 128 bytes minus the used register banks large. With three register banks that means only 104 bytes of <code>data</code> memory are available. Thus non-overlayable variables should be placed in <code>idata</code> in order to use <code>data</code> memory for well overlayable variables.</p>
<p>Furthermore SDCC does not build a complete call tree, so it cannot eliminate unused functions like C51/LX51 and only overlays leaf functions. I.e. only functions that call no other functions are overlaid.</p>
<p>For SDCC overlaying ISRs is not possible, that is why locals of ISRs should in most cases be placed in <code>idata</code>, despite the performance impact.</p>
<p>A limitation of C51/LX51 is that it ignores explicit memory assignments in function parameters and always places them in the default memory, if they cannot be passed in registers. This limitation does not appear to be documented, but it was reported by an ARM support employee in case #530915.</p>
<p>SDCC does not share this limitation, it can place function parameters in all kinds of memory. Because such assignments are ignored by C51/LX51, parameter memory type should be optimised for SDCC. Explicit memory assignments prevent parameters from being passed in registers. SDCC only passes the first non-<code>bool</code> parameter in registers, so optimizations should be performed on the non-overlayable arguments following it.</p>
<p>For single use functions like <code>init</code> and <code>enable</code> functions, it might make sense to pass parameters in <code>xdata</code>. In such cases the SDCC memory assignment style should be used, to give the C51 preprocessor the chance to remove the assignments. </p><div class="fragment"><div class="line">void hsk_can_init(const ubyte pins, const ulong __xdata baud);</div></div><!-- fragment --><p>If an application runs out of <code>data</code> space locals should be put into <code>idata</code> memory. Variables accessed by ISRs/ISR callbacks should be placed in <code>pdata</code> or <code>idata</code>. If that suffices the code should be checked for frequently accessed variables. The most frequent ones should be assigned to the default memory type if possible.</p>
<p>Both SDCC and C51 provide detailed information about memory use. The effects of relocating variables are often counter-intuitive, because it may interfere with several compiler and linker optimizations. This it is necessary to make use of this information in order to make sure that changes have the desired effect.</p>
<p>For SDCC check the assembler output for the <code>DSEG</code> area (search regex <code>/\\\.area DSEG/</code>): </p><div class="fragment"><div class="line">;--------------------------------------------------------</div><div class="line">; internal ram data</div><div class="line">;--------------------------------------------------------</div><div class="line">        .area DSEG    (DATA)</div><div class="line">_hsk_adc_init_resolution_1_71:</div><div class="line">        .ds 1</div><div class="line">_hsk_adc_init_ctc_1_72:</div><div class="line">        .ds 1</div><div class="line">_hsk_adc_init_sloc0_1_0:</div><div class="line">        .ds 2</div><div class="line">_hsk_adc_init_sloc1_1_0:</div><div class="line">        .ds 2</div></div><!-- fragment --><p>The <code>.map</code> file lists the complete memory layout produced by the linker (search regex <code>/^DSEG/</code>): </p><div class="fragment"><div class="line">Area                     Addr        Size        Decimal Bytes (Attributes)</div><div class="line">-----------------        ----        ----        ------- ----- ------------</div><div class="line">DSEG                 00000000    00000080 =         128. bytes (REL,CON)</div><div class="line"></div><div class="line">      Value  Global                              Global Defined In Module</div><div class="line">      -----  --------------------------------   ------------------------</div><div class="line">     00000018  _hsk_pwm_init_PARM_2               hsk_pwm</div><div class="line">     0000001C  _hsk_pwm_channel_set_PARM_2        hsk_pwm</div><div class="line">     0000001E  _hsk_pwm_channel_set_PARM_3        hsk_pwm</div><div class="line">     00000025  _hsk_icm7228_writeDec_PARM_2       hsk_icm7228</div><div class="line">     00000027  _hsk_icm7228_writeDec_PARM_3       hsk_icm7228</div><div class="line">     00000028  _hsk_icm7228_writeDec_PARM_4       hsk_icm7228</div><div class="line">...</div></div><!-- fragment --><p>In µVision the <code>.map</code> file can be accessed by double clicking the project in the project tree view (search string <code>"D A T A"</code>): </p><div class="fragment"><div class="line">START     STOP      LENGTH    ALIGN  RELOC    MEMORY CLASS   SEGMENT NAME</div><div class="line">=========================================================================</div><div class="line"></div><div class="line">* * * * * * * * * * *   D A T A   M E M O R Y   * * * * * * * * * * * * *</div><div class="line">000000H   000007H   000008H   ---    AT..     DATA           &quot;REG BANK 0&quot;</div><div class="line">000008H   00000FH   000008H   ---    AT..     DATA           &quot;REG BANK 1&quot;</div><div class="line">000010H   000017H   000008H   ---    AT..     DATA           &quot;REG BANK 2&quot;</div><div class="line">000018H   00001BH   000004H   BYTE   UNIT     IDATA          _IDATA_GROUP_</div><div class="line">00001CH.0 00001FH.7 000004H.0 ---    ---      **GAP**</div><div class="line">000020H.0 000020H.4 000000H.5 BIT    UNIT     BIT            _BIT_GROUP_</div><div class="line">000020H.5 000020H.5 000000H.1 BIT    UNIT     BIT            ?BI?HSK_CAN</div><div class="line">000020H.6 000020H   000000H.2 ---    ---      **GAP**</div><div class="line">000021H   00003FH   00001FH   BYTE   UNIT     DATA           _DATA_GROUP_</div><div class="line">000040H   000040H   000001H   BYTE   UNIT     IDATA          ?STACK</div></div><!-- fragment --><dl class="section see"><dt>See also</dt><dd>Overlaying in the SDCC manual </dd>
<dd>
Global Registers used for Parameter Passing in the SDCC manual </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jan 17 2017 00:45:19 for hsk-libs-dev by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
