<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>hsk-libs-dev: C51 Compiler Toolchain Setup</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">hsk-libs-dev
   &#160;<span id="projectnumber">257</span>
   </div>
   <div id="projectbrief">High Speed Karlsruhe XC878 library collection</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('toolchain.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">C51 Compiler Toolchain Setup </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This section describes the necessary compiler toolchain setup based on the Keil µVision IDE.</p>
<h1><a class="anchor" id="toolchain_device"></a>
Device</h1>
<p>It is critical for device flashing and programming to select the correct version of the µC. This dialogue also allows you to select the extended linker and assembler. Doing so is imperative to perform the necessary link time optimisations to fit the libraries into the limited memory of the device.</p>
<div class="image">
<img src="keil_options_Device.png" alt="keil_options_Device.png"/>
<div class="caption">
Keil µVision Device options dialogue</div></div>
<h1><a class="anchor" id="toolchain_target"></a>
Target</h1>
<p>The target dialogue lets you select several CPU architecture and memory layout settings.</p>
<p>The following options need to be set:</p><ul>
<li>Xtal (MHz):<ul>
<li>This needs to be set to your external oscillator frequency, otherwise flashing and debugging might be unreliable</li>
</ul>
</li>
<li>Memory Model: Small<ul>
<li>This setting means that variables are by default assigned to the first 128 bytes of directly addressable RAM, variables can still be mapped to different memory sections manaully as described in <a class="el" href="platform.html#platform_memory">Memory Limitations</a></li>
</ul>
</li>
<li>Code ROM Size: Large: 64K program<ul>
<li>This setting allows up to 64k of program data to be written to the device</li>
</ul>
</li>
<li>Use On-chip ROM</li>
<li>Use On-chip XRAM</li>
<li>Use multiple DPTR registers<ul>
<li>This allows the compiler to reduce address writes of reoccuring pointer targets by using multiple pointer registers</li>
</ul>
</li>
<li>Safe address extension SFR in interrupts<ul>
<li>XRAM/xdata access is not atomic. Thus interrupts using XRAM can interrupt and corrupt XRAM access of functions. This setting preserves the XRAM address registers and thus protects them from corruption</li>
</ul>
</li>
</ul>
<div class="image">
<img src="keil_options_Target.png" alt="keil_options_Target.png"/>
<div class="caption">
Keil µVision Target options dialogue</div></div>
<h1><a class="anchor" id="toolchain_c51"></a>
C51</h1>
<p>The C51 is the C compiler configuration dialogue. The following settings are not obligatory for use of the HSK libraries, but recommended.</p>
<ul>
<li>Preprocessor Symbols<ul>
<li>Define: <code>__xdata</code>, <code>__pdata</code>, <code>__idata</code><ul>
<li>This input field allows passing on preprocessor definitions to the preprocessor</li>
<li>The empty <code>__xdata</code>, <code>__pdata</code>, <code>__idata</code> defines allow C51 to ignore SDCC style memory assignments, this is useful to make such assignments where C51 does not support them</li>
</ul>
</li>
</ul>
</li>
<li>Code Optimization<ul>
<li>Level: 11: Reuse Common Exit Code<ul>
<li>The highest level of optimisation, allowing the compiler the largest reduction of memory use</li>
<li>Select <code>4</code> or lower for debugging, all the common code eliminations prevent the debugger from mapping large chunks of C code to assembler code, making the program flow difficult to follow</li>
</ul>
</li>
<li>Emphasis: Favor speed<ul>
<li>Surprisingly this often produces smaller code than the <code>favor size</code> setting</li>
</ul>
</li>
<li>Global Register Coloring<ul>
<li>This setting allows the compiler to optimise register use throughout the entire application, reducing memory use and improving performance</li>
</ul>
</li>
<li>Linker Code Packing<ul>
<li>Activates a link time optimisation, after linking the application, the linker will replace long distance jumps with short jumps where applicable</li>
</ul>
</li>
</ul>
</li>
<li>Warnings: Warninglevel 2</li>
<li>Enable ANSI integer promotion rules</li>
</ul>
<div class="image">
<img src="keil_options_C51.png" alt="keil_options_C51.png"/>
<div class="caption">
Keil µVision C51 options dialogue</div></div>
<h1><a class="anchor" id="toolchain_lx51_locate"></a>
LX51 Locate</h1>
<p>LX51 is the extended linker of the C51 compiler tool chain, the Locate dialogue is used to map memory ranges. The form can also be used to assign portions of code to fixed addresses.</p>
<ul>
<li>User Memory Layout from Target Dialog<ul>
<li>This option assigns the XC878 memory types to the appropriate address ranges</li>
</ul>
</li>
<li>User Classes: PDATA (X:0xF000-X:0xF0FF)<ul>
<li>This option maps the <code>pdata</code> memory into the first 256 bytes of <code>xdata</code></li>
</ul>
</li>
</ul>
<div class="image">
<img src="keil_options_LX51_Locate.png" alt="keil_options_LX51_Locate.png"/>
<div class="caption">
Keil µVision LX51 Locate options dialogue</div></div>
<h1><a class="anchor" id="toolchain_lx51_misc"></a>
LX51 Misc</h1>
<p>The Misc dialogue holds the remaining linker settings.</p>
<ul>
<li>Overlay<ul>
<li>This field can be used to add calls through function pointers to the call tree as is necessary for callback functions, the syntax is described in the µVision Help section OVERLAY Linker Directive</li>
<li>Manually filling this field can be avoided by running the <code>uVisionupdate</code>.sh script</li>
</ul>
</li>
<li>Misc controls: REMOVEUNUSED<ul>
<li>This linker flag saves memory by discarding unused functions</li>
</ul>
</li>
</ul>
<div class="image">
<img src="keil_options_LX51_Misc.png" alt="keil_options_LX51_Misc.png"/>
<div class="caption">
Keil µVision LX51 Misc options dialogue</div></div>
<h1><a class="anchor" id="toolchain_inline_asm"></a>
Inline Assembler</h1>
<p>Inline assembler has to be activated for Groups or single files individually. The Group Options can be found in the context menu of a Group.</p>
<p>To activate an option in this menu it needs to be unchecked and checked again.</p>
<ul>
<li>Generate Assembler SRC File<ul>
<li>This option causes the compiler to generate assembler code instead of an object file</li>
</ul>
</li>
<li>Assemble SRC File<ul>
<li>This option causes the compiler to assemble the generated assembler code</li>
</ul>
</li>
</ul>
<div class="image">
<img src="keil_options_Group.png" alt="keil_options_Group.png"/>
<div class="caption">
Keil µVision Group options dialogue</div></div>
<h1><a class="anchor" id="toolchain_program"></a>
Device Programming and Debugging</h1>
<p>To program or debug the device via On Chip Debug Support (OCDS) the Infineon Direct Access Server (DAS), a hardware access middleware, is required. The programming and debugging options can also be selected from the target options. Use the following settings in the Utilities tab:</p>
<ul>
<li>Use Target Driver for Flash Programming<ul>
<li>Infineon DAS Client for XC800</li>
</ul>
</li>
</ul>
<div class="image">
<img src="keil_options_Utilities.png" alt="keil_options_Utilities.png"/>
<div class="caption">
Keil µVision LX51 Utilities options dialogue</div></div>
<dl class="section see"><dt>See also</dt><dd>Infineon DAS Tool Interface website: <a href="http://www.infineon.com/das/">http://www.infineon.com/das/</a></dd></dl>
<p>Select <code>Settings</code> to enter the "Infineon XC800 DAS Driver Setup". The default options are mostly fine. Make sure of the following options:</p>
<ul>
<li>DAS Server: UDAS</li>
<li>Target Debug Options<ul>
<li>Miscellaneous Options<ul>
<li>Disable Interrupts during Steps<ul>
<li>Frequently occuring interrupts like timer interrupts make step by step debugging completely useless</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="image">
<img src="DAS_Driver_Setup.png" alt="DAS_Driver_Setup.png"/>
<div class="caption">
Keil µVision Infineon XC800 DAS Driver Setup</div></div>
<p>The Debug tab of the target options can be used to choose between in-simulator debugging and on-chip debugging. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jan 17 2017 00:45:19 for hsk-libs-dev by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
