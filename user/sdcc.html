<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>hsk-libs-user: Using the Small Device C Compiler (SDCC)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">hsk-libs-user
   &#160;<span id="projectnumber">257</span>
   </div>
   <div id="projectbrief">High Speed Karlsruhe XC878 library collection</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('sdcc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using the Small Device C Compiler (SDCC) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This section describes how to compile code for the XC878 with the Small Device C Compiler. SDCC is an open source compiler supporting several 8 bit architectures.</p>
<p>This section is about using the compiler and maintaining <a class="el" href="toolchain.html">C51</a> compatibility. Refer to <a class="el" href="make.html">The Project Makefile</a> to build this project using SDCC.</p>
<dl class="section see"><dt>See also</dt><dd>SDCC project: <a href="http://sdcc.sf.net">http://sdcc.sf.net</a> </dd>
<dd>
Small Device C Compiler Manual: <a href="http://sdcc.sourceforge.net/doc/sdccman.pdf">sdccman.pdf</a></dd></dl>
<h1><a class="anchor" id="sdcc_arch"></a>
Processor Architecture</h1>
<p>The 8051 architecture is selected with the parameter <code>-mmcs51</code>. Additionally the compiler needs to be invoked with the correct memory architecture, XRAM starts at addres 0xF000 and is 3kb wide. For this the parameters <code>--xram-loc</code> and <code>--xram-size</code> are provided: </p><pre class="fragment">-mmcs51 --xram-loc 0xF000 --xram-size 3072
</pre><h1><a class="anchor" id="sdcc_header"></a>
SDCC Header File for XC878</h1>
<p>This projects includes the file Infineon/XC878.h in the inc/ directory, which contains the SFR definitions for the XC878. It is a modified version of the XC878.h file proivided by Keil µVision, which in turn is a Dave generated file.</p>
<p>The modification is an <code>#ifdef SDCC</code> block, with some compatibility glue to allow using the C51 code mostly unmodified.</p>
<p>To make the header available to <code>sdcc</code> the inc/ should be added to the include search path with the <code>-I</code> parameter: </p><pre class="fragment">-mmcs51 --xram-loc 0xF000 --xram-size 3072 -I inc/
</pre><h1><a class="anchor" id="sdcc_compiling"></a>
Compiling Code</h1>
<p>Code is compiled using the <code>-c</code> parameter: </p><pre class="fragment">sdcc -mmcs51 --xram-loc 0xF000 --xram-size 3072 -I inc/ -o builddir/ -c example.c
</pre><p>The compiler will generate a number of files in builddir, among them <code>example.asm</code> and <code>example.rel,</code> the object file.</p>
<p>Instead of the build dir the output parameter <code>-o</code> can also take the name of the object file as a parameter.</p>
<p>SDCC can only compile one .c file at a time, thus every .c file must be compiled separately and linked in a separate step later.</p>
<h1><a class="anchor" id="sdcc_linking"></a>
Linking</h1>
<p>Linking can be done by giving all required object files as parameters. The output file name will be based on the first input file or can explicitely be stated:</p>
<pre class="fragment">sdcc -mmcs51 --xram-loc 0xF000 --xram-size 3072 -I inc/ -o builddir/ -c example.rel lib1.rel lib2.rel
</pre><p>The output file would be <code>builddir/example.ihx</code> (Intel HEX). <code>-o</code> <code>builddir/example.hex</code> can be used to change the filename suffix to <code>.hex</code>, which is more convenient when using XC800_FLOAD to flash the µC.</p>
<h1><a class="anchor" id="sdcc_programming"></a>
Programming</h1>
<p>Whereas µVision as an IDE covers flashing, SDCC users need a separate tool to do so. One such tool is Infineon's XC800_FLOAD. FLOAD also requires DAS.</p>
<p>The use of FLOAD is very straightforward, make the following settings:</p><ul>
<li>Protocol: JTAG/SPD</li>
<li>Physical Interface: UDAS/JTAG over USB</li>
<li>Target Device: XC87x-16FF</li>
</ul>
<div class="image">
<img src="XC800_FLOAD.png" alt="XC800_FLOAD.png"/>
<div class="caption">
XC800_FLOAD Flash Programming Tool</div></div>
<p>The important functions of FLOAD are:</p><ul>
<li>Open: Open a HEX file for programming</li>
<li>Download: Download the program to the µC flash</li>
<li>Flash Erase: Clear the µC flash memory</li>
</ul>
<dl class="section see"><dt>See also</dt><dd>FLOAD download: <a href="http://www.infineon.com/cms/en/product/microcontrollers/development-tools,-software-and-kits/xc800-development-tools,-software-and-kits/software-downloads/channel.html?channel=db3a304319c6f18c011a0b54923431e5">http://www.infineon.com/cms/en/product/microcontrollers/development-tools,-software-and-kits/xc800-development-tools,-software-and-kits/software-downloads/channel.html?channel=db3a304319c6f18c011a0b54923431e5</a> </dd>
<dd>
Infineon DAS Tool Interface website: <a href="http://www.infineon.com/das/">http://www.infineon.com/das/</a></dd></dl>
<h1><a class="anchor" id="sdcc_memory"></a>
Memory Usage Compatibility</h1>
<p>In order to write compatible code, the compatiblity glue in the Infineon/XC878.h header maps keywords like <code>data</code>, <code>idata</code>, <code>xdata</code> etc. to their SDCC equivalents <code>__data</code>, <code>__idata</code> and <code>__xdata</code>.</p>
<p>Starting with SDCC 3.x C51 <code>code</code> and SDCC <code>__code</code> are largely interchangeable. This wasn't always the case, which results in two different styles for using <code>code</code>.</p>
<p>E.g. putting a variable into <code>code</code> space, C51 style: </p><div class="fragment"><div class="line">ubyte code foo = 0x2A;</div></div><!-- fragment --><p>SDCC style: </p><div class="fragment"><div class="line">const ubyte foo = 0x2A;</div></div><!-- fragment --><p>The C51 style is consistent with other variable space assignments and portable (it did not work with SDCC 2.x, but works with 3.x). The SDCC style is more logical in terms of writing code that communicates what one intends to do. The recommendation within this project is to use a redundant style, which also worked with SDCC 2.x with some C macro magic: </p><div class="fragment"><div class="line">const ubyte code foo = 0x2A;</div></div><!-- fragment --><p><b>Function pointers</b> are a special case. To SDCC all function pointers refer to <code>code</code>, C51 uses (slower, larger) generic pointers if the <code>code</code> keyword is missing. Unfortunately there is no compatible syntax to place <code>code</code> in a function pointer declaration. This can be circumvented with preprocessor instructions: </p><div class="fragment"><div class="line">/*</div><div class="line"> * SDCC does not like the \c code keyword for function pointers, C51 needs it</div><div class="line"> * or it will use generic pointers.</div><div class="line"> */</div><div class="line">#ifdef SDCC</div><div class="line">        #undef code</div><div class="line">        #define code</div><div class="line">#endif /* SDCC */</div></div><!-- fragment --><p> A function pointer declaration may look like this: </p><div class="fragment"><div class="line">void (code *foo)(void);</div></div><!-- fragment --><p>Take care to restore <code>code</code> before the end of a <code>.h</code> file: </p><div class="fragment"><div class="line">/*</div><div class="line"> * Restore the usual meaning of \c code.</div><div class="line"> */</div><div class="line">#ifdef SDCC</div><div class="line">        #undef code</div><div class="line">        #define code    __code</div><div class="line">#endif /* SDCC */</div></div><!-- fragment --> <h1><a class="anchor" id="sdcc_interrupts"></a>
Interrupts</h1>
<p>The most significant difference between interrupt handling in SDCC and C51 is that prototypes for the interrupts must be visible in the context of the <a class="el" href="main_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667" title="Call init functions and invoke the run routine. ">main()</a> function.</p>
<p>These prototypes can be enclosed in an <code>#ifdef</code>: </p><div class="fragment"><div class="line">#ifndef _HSK_ISR_ISR_</div><div class="line">#define _HSK_ISR_ISR_</div><div class="line">void ISR_hsk_isr5(void) interrupt 5 using 1;</div><div class="line">void ISR_hsk_isr6(void) interrupt 6 using 1;</div><div class="line">void ISR_hsk_isr8(void) interrupt 8 using 1;</div><div class="line">void ISR_hsk_isr9(void) interrupt 9 using 1;</div><div class="line">void ISR_hsk_isr14(void) interrupt 14 using 2;</div><div class="line">#endif /* _HSK_ISR_ISR_ */</div><div class="line"></div></div><!-- fragment --><p>According to the SDCC manual functions called by ISRs must be reentrant or protected from memory overlay. This is done with a compiler instruction: </p><div class="fragment"><div class="line">#pragma save</div><div class="line">#pragma nooverlay</div><div class="line">void isr_callback(void) using 1 {</div><div class="line">        [...]</div><div class="line">}</div><div class="line">#pragma restore</div></div><!-- fragment --><p>Unfortunately this causes a compiler warning when using C51: </p><pre class="fragment">..\src\main.c(49): warning C245: unknown #pragma, line ignored
</pre><p>This can be avoided by making nooverlay conditional: </p><div class="fragment"><div class="line">#pragma save</div><div class="line">#ifdef SDCC</div><div class="line">#pragma nooverlay</div><div class="line">#endif</div><div class="line">void isr_callback(void) using 1 {</div><div class="line">        [...]</div><div class="line">}</div><div class="line">#pragma restore</div></div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jan 17 2017 00:45:19 for hsk-libs-user by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
